services:
  # qBittorrent
  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    env_file:
      - .env
    environment:
      - WEBUI_PORT=8080
    volumes:
      - ./config/qbittorrent:/config
      - ./downloads:/downloads
      - ./media:/media
    ports:
      - "8080:8080"
      - "6881:6881"
      - "6881:6881/udp"
    restart: unless-stopped
    networks:
      - plexstack

  # Sonarr
  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    env_file:
      - .env
    volumes:
      - ./config/sonarr:/config
      - ./downloads:/downloads
      - ./media/tv:/tv
    ports:
      - "8989:8989"
    restart: unless-stopped
    depends_on:
      - qbittorrent
    networks:
      - plexstack

  # Radarr
  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    env_file:
      - .env
    volumes:
      - ./config/radarr:/config
      - ./downloads:/downloads
      - ./media/movies:/movies
    ports:
      - "7878:7878"
    restart: unless-stopped
    depends_on:
      - qbittorrent
    networks:
      - plexstack

  # Prowlarr
  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    env_file:
      - .env
    volumes:
      - ./config/prowlarr:/config
    ports:
      - "9696:9696"
    restart: unless-stopped
    depends_on:
      - sonarr
      - radarr
    networks:
      - plexstack

  # Plex Media Server
  plex:
    image: plexinc/pms-docker:plexpass
    container_name: plex
    env_file:
      - .env
    environment:
      - PLEX_CLAIM=${PLEX_CLAIM}
    volumes:
      - ./config/plex:/config
      - ./media:/media
      - transcode:/transcode
    ports:
      - "32400:32400"
    restart: unless-stopped
    networks:
      - plexstack

  # Rclone mount (for cloud media)
  rclone:
    image: rclone/rclone:latest
    container_name: rclone
    env_file:
      - .env
    command: mount ${RCLONE_REMOTE} ${RCLONE_MOUNT_PATH} --config /config/rclone/rclone.conf --allow-other --daemon
    cap_add:
      - SYS_ADMIN
    devices:
      - /dev/fuse
    security_opt:
      - apparmor:unconfined
    volumes:
      - ./config/rclone:/config/rclone
      - ./media/gdrive:/media/gdrive
    restart: unless-stopped
    networks:
      - plexstack

  # Nginx Proxy Manager
  nginx-proxy-manager:
    image: jc21/nginx-proxy-manager:latest
    container_name: nginx-proxy-manager
    env_file:
      - .env
    volumes:
      - ./config/nginx-proxy-manager/data:/data
      - ./config/nginx-proxy-manager/letsencrypt:/etc/letsencrypt
    ports:
      - "80:80"
      - "81:81"
      - "443:443"
    restart: unless-stopped
    networks:
      - plexstack

  # Portainer (Docker GUI)
  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    command: -H unix:///var/run/docker.sock
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./config/portainer:/data
    ports:
      - "9000:9000"
    restart: unless-stopped
    networks:
      - plexstack

  # Auto-config script (links all the above via their APIs)
  autoconfig:
    image: alpine:latest
    container_name: auto-config
    env_file:
      - .env
    volumes:
      - ./scripts/auto-config.sh:/init/auto-config.sh:ro
    entrypoint: ["/bin/sh", "/init/auto-config.sh"]
    depends_on:
      - sonarr
      - radarr
      - prowlarr
      - qbittorrent
    networks:
      - plexstack

# Transcode directory for Plex
volumes:
  transcode:

# Shared network for all services
networks:
  plexstack:
    driver: bridge
